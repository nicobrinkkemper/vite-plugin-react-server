{"version":3,"file":"index.js","sourceRoot":"","sources":["../../../plugin/transformer/index.ts"],"names":[],"mappings":"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","sourcesContent":["import type { Plugin } from \"vite\";\nimport { normalizePath } from \"vite\";\nimport { DEFAULT_CONFIG } from \"../options.js\";\nimport { createRscTransformer } from \"./transformer.js\";\nimport type { ViteReactClientTransformOptions } from \"./types.js\";\n\n\n/**\n * Plugin for transforming React Client Components.\n *\n * Core responsibilities:\n * 1. Detects \"use client\" directives\n * 2. Transforms client components for RSC boundaries\n * 3. Adds client reference metadata for RSC\n *\n * When a component is marked with \"use client\", it:\n * - Gets transformed into a client reference\n * - Maintains module ID for RSC boundaries\n * - Preserves class/function behavior\n *\n * @example\n * ```ts\n * export default defineConfig({\n *   plugins: [\n *     viteReactClientTransformPlugin({\n *       projectRoot: process.cwd(),\n *     })\n *   ]\n * });\n * ```\n */\n\nexport function viteReactClientTransformPlugin(\n  options?: ViteReactClientTransformOptions\n): Plugin {\n  if(process.env['NODE_OPTIONS']?.match(/--conditions=react-server/)) {\n    console.log('react-server')\n  } else {\n    throw new Error('react-server condition not found, set NODE_OPTIONS=\"--conditions react-server\"')\n  }\n  const projectRoot = options?.projectRoot || process.cwd();\n  const include = options?.include || DEFAULT_CONFIG.FILE_REGEX;\n  const exclude = options?.exclude;\n  let transform: any;\n  // get the file we are imported from (parent)\n\n  return {\n    name: \"vite:react-stream-transformer\",\n    enforce: \"pre\",\n\n    configResolved(config) {\n      transform = createRscTransformer({\n        moduleId:\n          options?.moduleId ||\n          moduleIdDefault({\n            projectRoot: projectRoot,\n            output: {\n              dir: config.build?.outDir ?? DEFAULT_CONFIG.BUILD.server,\n            },\n            isProduction: config.isProduction,\n          }),\n      }).transform;\n    },\n\n    transform(code: string, id: string, opts) {\n      // Skip if file doesn't match patterns\n      if (\n        !matchPattern(id, include) ||\n        (exclude && matchPattern(id, exclude))\n      ) {\n        return null;\n      }\n\n      // Look for use client directive at start of file (no exceptions)\n      const directiveMatch =\n        code.startsWith('\"use client\"') || code.startsWith(\"'use client'\");\n      if (!directiveMatch) return null;\n\n      // Transform client components\n      return transform(code, id, opts);\n    },\n  };\n}\n\nconst moduleIdDefault =\n  ({\n    projectRoot,\n    output: _,\n    isProduction,\n  }: {\n    isProduction: boolean;\n    projectRoot: string;\n    output: { dir: string };\n  }) =>\n  (moduleId: string) => {\n    const normalized = normalizePath(moduleId);\n    const noRoot = normalized.startsWith(projectRoot)\n      ? normalized.slice(projectRoot.length)\n      : normalized;\n    if (!isProduction) {\n      return noRoot;\n    }\n    return noRoot.replace(DEFAULT_CONFIG.FILE_REGEX, \".js\");\n  };\n\nconst matchPattern = (\n  file: string,\n  pattern: string | RegExp | (string | RegExp)[]\n) =>\n  Array.isArray(pattern)\n    ? pattern.some((p) => file.match(p as RegExp))\n    : file.match(pattern as RegExp);\n"]}